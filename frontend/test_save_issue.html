<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Learning Path Save</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Learning Path Save Debug Tool</h1>
        
        <div class="test-section info">
            <h3>Test Configuration</h3>
            <p>Backend URL: <span id="backend-url">http://localhost:8000</span></p>
            <p>Username: <span id="username">Not logged in</span></p>
            <p>Token: <span id="token-status">Not available</span></p>
        </div>

        <div class="test-section">
            <h3>Step 1: Check Backend Status</h3>
            <button onclick="checkBackendStatus()">Test Backend Connection</button>
            <div id="backend-status" class="log"></div>
        </div>

        <div class="test-section">
            <h3>Step 2: Check Learning Paths Endpoint</h3>
            <button onclick="checkLearningPathsEndpoint()">Test Learning Paths List</button>
            <div id="learning-paths-status" class="log"></div>
        </div>

        <div class="test-section">
            <h3>Step 3: Test Save Learning Path</h3>
            <button onclick="testSaveLearningPath()">Test Save Learning Path</button>
            <div id="save-test-status" class="log"></div>
        </div>

        <div class="test-section">
            <h3>Debug Information</h3>
            <button onclick="showDebugInfo()">Show Debug Info</button>
            <div id="debug-info" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        // Check authentication status
        function updateAuthStatus() {
            const username = localStorage.getItem('username');
            const token = localStorage.getItem('token');
            
            document.getElementById('username').textContent = username || 'Not logged in';
            document.getElementById('token-status').textContent = token ? 'Available' : 'Not available';
        }

        // Log function
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toISOString();
            const logMessage = `[${timestamp}] ${message}\n`;
            element.textContent += logMessage;
            console.log(message);
        }

        // Check backend status
        async function checkBackendStatus() {
            const statusDiv = document.getElementById('backend-status');
            statusDiv.textContent = '';
            
            try {
                log('backend-status', 'Testing backend connection...');
                const response = await fetch(`${API_BASE_URL}/api/status`);
                const data = await response.json();
                
                if (response.ok) {
                    log('backend-status', '✅ Backend is running successfully!');
                    log('backend-status', `Version: ${data.version}, Status: ${data.status}`);
                } else {
                    log('backend-status', `❌ Backend error: ${response.status} ${response.statusText}`, true);
                }
            } catch (error) {
                log('backend-status', `❌ Backend connection failed: ${error.message}`, true);
            }
        }

        // Check learning paths endpoint
        async function checkLearningPathsEndpoint() {
            const statusDiv = document.getElementById('learning-paths-status');
            statusDiv.textContent = '';
            
            try {
                log('learning-paths-status', 'Testing learning paths endpoint...');
                const testUsername = localStorage.getItem('username') || 'test';
                
                const response = await fetch(`${API_BASE_URL}/learning-paths/list?username=${testUsername}`);
                const data = await response.json();
                
                if (response.ok) {
                    log('learning-paths-status', '✅ Learning paths endpoint is working!');
                    log('learning-paths-status', `Found ${data.learning_paths.length} existing learning paths`);
                    log('learning-paths-status', `Response: ${JSON.stringify(data, null, 2)}`);
                } else {
                    log('learning-paths-status', `❌ Learning paths endpoint error: ${response.status} ${response.statusText}`, true);
                }
            } catch (error) {
                log('learning-paths-status', `❌ Learning paths endpoint failed: ${error.message}`, true);
            }
        }

        // Test save learning path
        async function testSaveLearningPath() {
            const statusDiv = document.getElementById('save-test-status');
            statusDiv.textContent = '';
            
            try {
                const username = localStorage.getItem('username');
                const token = localStorage.getItem('token');
                
                if (!username || !token) {
                    log('save-test-status', '❌ Cannot test save: User not authenticated. Please log in to the main app first.', true);
                    return;
                }

                log('save-test-status', 'Testing save learning path...');
                
                // Sample learning path data
                const testPathData = {
                    name: "Test Learning Path " + Date.now(),
                    description: "A test learning path to verify the save functionality",
                    difficulty: "Beginner",
                    duration: "2-3 weeks",
                    prerequisites: [],
                    topics: [
                        {
                            name: "Introduction to Testing",
                            description: "Learn the basics of testing",
                            time_required: "2 hours",
                            links: [],
                            videos: [],
                            subtopics: [],
                            completed: false
                        },
                        {
                            name: "Advanced Testing Techniques",
                            description: "Master advanced testing methods",
                            time_required: "3 hours",
                            links: [],
                            videos: [],
                            subtopics: [],
                            completed: false
                        }
                    ],
                    tags: ["testing", "debug"]
                };

                log('save-test-status', `Sending request to: ${API_BASE_URL}/learning-paths/create`);
                log('save-test-status', `Username: ${username}`);
                log('save-test-status', `Path data: ${JSON.stringify(testPathData, null, 2)}`);

                const response = await fetch(`${API_BASE_URL}/learning-paths/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        username: username,
                        path_data: testPathData
                    })
                });

                log('save-test-status', `Response status: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    log('save-test-status', '✅ Learning path saved successfully!');
                    log('save-test-status', `Result: ${JSON.stringify(result, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    log('save-test-status', `❌ Save failed: ${response.status} ${response.statusText}`, true);
                    log('save-test-status', `Error details: ${errorText}`, true);
                }
            } catch (error) {
                log('save-test-status', `❌ Save request failed: ${error.message}`, true);
                log('save-test-status', `Stack trace: ${error.stack}`, true);
            }
        }

        // Show debug information
        function showDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.textContent = '';
            
            log('debug-info', '=== DEBUG INFORMATION ===');
            log('debug-info', `Current URL: ${window.location.href}`);
            log('debug-info', `Backend URL: ${API_BASE_URL}`);
            log('debug-info', `User Agent: ${navigator.userAgent}`);
            
            // Local storage info
            log('debug-info', '\n=== LOCAL STORAGE ===');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                // Don't log sensitive data like tokens completely
                if (key === 'token') {
                    log('debug-info', `${key}: ${value ? 'Present (length: ' + value.length + ')' : 'Not present'}`);
                } else {
                    log('debug-info', `${key}: ${value}`);
                }
            }
            
            // Console errors (if any)
            log('debug-info', '\n=== CONSOLE SETUP ===');
            log('debug-info', 'This debug tool is ready. Open browser dev tools to see additional network logs.');
            
            // Network connectivity
            log('debug-info', '\n=== NETWORK STATUS ===');
            log('debug-info', `Online: ${navigator.onLine}`);
            log('debug-info', `Connection: ${navigator.connection ? navigator.connection.effectiveType : 'Unknown'}`);
        }

        // Initialize
        window.addEventListener('load', () => {
            updateAuthStatus();
            log('debug-info', 'Debug tool loaded successfully');
        });
    </script>
</body>
</html>
